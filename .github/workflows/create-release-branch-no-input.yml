# .github/workflows/create-release-branch-no-input.yml
name: Create Feature Branches in Repos - no input

on:
  # This workflow can be run manually from the Actions tab.
  # It sources its configuration from organization variables.
  workflow_dispatch:

jobs:
  create-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (for the workflow itself)
        uses: actions/checkout@v4

      - name: Create Branches and Update Version
        env:
          # The PAT is required and read from secrets.
          GH_TOKEN: ${{ secrets.ORG_ADMIN_PAT }}
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.

          # --- CONFIGURATION FROM ORGANIZATION VARIABLES ---
          # All configuration is now sourced from org variables with sensible fallbacks.
          ORG_NAME="${{ vars.TARGET_ORG_NAME || github.repository_owner }}"
          BRANCH_NAME="${{ vars.FEATURE_BRANCH_NAME }}"
          NEW_VERSION="${{ vars.MAIN_VERSION }}"
          VERSION_VARIABLE="${{ vars.MAKEFILE_VERSION_VAR || 'VERSION' }}"
          BRANCH_VARIABLE="${{ vars.MAKEFILE_BRANCH_VAR || 'BRANCH' }}"
          OPENSTACK_K8S_TAG_VARIABLE="${{ vars.MAKEFILE_OPENSTACK_K8S_TAG_VAR || 'OPENSTACK_K8S_TAG' }}"
          TRIGGER_BRANCH="${{ vars.TRIGGER_BRANCH_NAME || 'olive' }}"
          SOURCE_BRANCH="${{ vars.SOURCE_BRANCH_NAME || 'main' }}"

          # Validate that required variables are set
          if [[ -z "$BRANCH_NAME" ]] || [[ -z "$NEW_VERSION" ]]; then
            echo "Error: Required organization variables FEATURE_BRANCH_NAME or MAIN_VERSION are not set."
            exit 1
          fi
          
          echo "Running with the following configuration:"
          echo "Organization: ${ORG_NAME}"
          echo "Feature Branch Name: ${BRANCH_NAME}"
          echo "New Version on main: ${NEW_VERSION}"
          echo "Trigger Branch: ${TRIGGER_BRANCH}"
          echo "Source Branch: ${SOURCE_BRANCH}"
          echo "-------------------------------------------"
          
          echo "Searching for repositories in organization '${ORG_NAME}'..."
          repos=$(gh repo list $ORG_NAME --limit 1000 --json name --jq '.[] | .name')

          if [ -z "$repos" ]; then
            echo "No repositories found in the organization or permissions are missing."
            exit 1
          fi

          created_repos=""

          for repo_name in $repos; do
            echo "--- Checking repository: ${repo_name} ---"

            # Check if the trigger branch exists by checking the exit code of the API call.
            if gh api "repos/${ORG_NAME}/${repo_name}/branches/${TRIGGER_BRANCH}" >/dev/null 2>&1; then
              echo "✅ Trigger branch '${TRIGGER_BRANCH}' found in ${repo_name}."

              TEMP_DIR=$(mktemp -d)
              echo "Cloning repository into ${TEMP_DIR}..."
              git clone "https://x-access-token:${GH_TOKEN}@github.com/${ORG_NAME}/${repo_name}.git" "$TEMP_DIR"
              
              cd "$TEMP_DIR"

              if ! git show-ref --verify --quiet "refs/remotes/origin/${SOURCE_BRANCH}"; then
                echo "⚠️ Source branch '${SOURCE_BRANCH}' does not exist in ${repo_name}. Skipping."
                cd ..
                rm -rf "$TEMP_DIR"
                continue
              fi

              # Skip the entire repository if the new branch already exists.
              if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH_NAME}"; then
                echo "ℹ️ Branch '${BRANCH_NAME}' already exists in ${repo_name}. Skipping this repository."
                cd ..
                rm -rf "$TEMP_DIR"
                continue
              fi
              
              # --- LOGIC: CREATE AND UPDATE THE NEW BRANCH ---
              echo "Creating branch '${BRANCH_NAME}' from '${SOURCE_BRANCH}'..."
              git checkout ${SOURCE_BRANCH}
              git checkout -b ${BRANCH_NAME}

              if [ -f "Makefile" ]; then
                made_changes=false
                echo "Makefile found. Checking for variables to update on new branch..."

                # ALL repos - Update the BRANCH variable
                if grep -qE "^${BRANCH_VARIABLE}\s*(\?=|=)" Makefile; then
                  echo "Updating variable '${BRANCH_VARIABLE}' to '${BRANCH_NAME}'."
                  sed -i -E "s/^(${BRANCH_VARIABLE}\s*(\?=|=)\s*).*/\1${BRANCH_NAME}/" Makefile
                  made_changes=true
                fi

                # install_yamls - Update the OPENSTACK_K8S_TAG variable
                if [[ "$repo_name" == "install_yamls" ]]; then
                  if grep -qE "^${OPENSTACK_K8S_TAG_VARIABLE}\s*(\?=|=)" Makefile; then
                    NEW_K8S_TAG="${BRANCH_NAME}-latest"
                    echo "Updating variable '${OPENSTACK_K8S_TAG_VARIABLE}' to '${NEW_K8S_TAG}'."
                    sed -i -E "s/^(${OPENSTACK_K8S_TAG_VARIABLE}\s*(\?=|=)\s*).*/\1${NEW_K8S_TAG}/" Makefile
                    made_changes=true
                  fi
                fi
                  
                # Commit the changes only if a modification was made
                if [ "$made_changes" = true ]; then                  
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add Makefile
                  git commit -m "[${BRANCH_NAME}] Update Makefile for ${BRANCH_NAME}"
                  echo "Commit for version update created."
                else
                  echo "No updates in the Makefile. No commit will be created for this branch."
                fi                    
              else
                  echo "No Makefile found. No changes will be committed to new branch."
              fi
              
              # Push the new branch with the potential new commit
              git push origin ${BRANCH_NAME}
              echo "Branch successfully pushed."
              created_repos+="${repo_name}\n"

              if [[ "$repo_name" == "openstack-operator" ]]; then
                # --- LOGIC: UPDATE SOURCE BRANCH AFTERWARDS ---
                git checkout ${SOURCE_BRANCH}
                # Ensure we have the latest version of the source branch before making changes
                git pull origin ${SOURCE_BRANCH}

                if [ -f "Makefile" ]; then
                  # Construct the full version string by appending ".0"
                  FULL_MAKEFILE_VERSION="${NEW_VERSION}.0"

                  # Conditionally update the main VERSION variable on the source branch
                  if grep -qE "^${VERSION_VARIABLE}\s*(:=|\?=|=)" Makefile; then
                    echo "Updating variable '${VERSION_VARIABLE}' to '${FULL_MAKEFILE_VERSION}' on branch '${SOURCE_BRANCH}'."
                    sed -i -E "s/^(${VERSION_VARIABLE}\s*(:=|\?=|=)).*/\1 ${FULL_MAKEFILE_VERSION}/" Makefile
                    
                    # Commit and push the change to the source branch
                    git config --global user.name "github-actions[bot]"
                    git config --global user.email "github-actions[bot]@users.noreply.github.com"
                    git add Makefile
                    git commit -m "Bump version to ${NEW_VERSION}"
                    echo "Pushing version update to ${SOURCE_BRANCH}..."
                    git push origin ${SOURCE_BRANCH}
                  else
                    echo "Variable '${VERSION_VARIABLE}' not found. No changes pushed to ${SOURCE_BRANCH}."
                  fi
                else
                  echo "No Makefile found. No changes pushed to ${SOURCE_BRANCH}."
                fi
              fi
              
              # Clean up
              cd ..
              rm -rf "$TEMP_DIR"

            else
              echo "❌ Trigger branch '${TRIGGER_BRANCH}' not found in ${repo_name}. Skipping."
            fi
          done

          echo "-------------------------------------------"
          echo "Summary of created repos where the new branch ${BRANCH_NAME} got created:"
          if [[ -n "$created_repos" ]]; then
            echo -e "$created_repos"
          else
            echo "No new branches were created."
          fi
          echo "Workflow finished."
